<?php require('utils.php');$scriptname = $_SERVER['PHP_SELF'];$submit = $HTTP_GET_VARS['submit'];if (! $submit) { $submit = "qE-E"; };$searchmax = 250;$headerColor = '#ffffaa';$resultsColor = '#ccffcc';$barColor = '#cccccc';$rel = $HTTP_GET_VARS['rel'];$e = $HTTP_GET_VARS['e'];$t = $HTTP_GET_VARS['t'];$e1 = $HTTP_GET_VARS['e1'];$e2 = $HTTP_GET_VARS['e2'];function setSelected ($submit,$optionName) {	// set selected value for options in queryType menu	if ($submit == $optionName) { echo ' selected'; }	elseif (! $submit & $optionName == 'qE-E') { echo ' selected'; }}function queryDB ($q1,$q2){	// Collect all rows from two database queries.	global $db_conn;	//echo "$q1<p>$q2<p>";	$result1 = mysql_query($q1, $db_conn);  	if (mysql_errno()) { printMySqlErrors($q,$_SERVER['SCRIPT_NAME'] . ":" . __LINE__); }	$result2 = mysql_query($q2, $db_conn);  	if (mysql_errno()) { printMySqlErrors($q2,$_SERVER['SCRIPT_NAME'] . ":" . __LINE__); }	$rows = Array();	while ($row = mysql_fetch_row($result1)) { $rows[] = $row; }	while ($row = mysql_fetch_row($result2)) { $rows[] = $row; }	return $rows;}function echoResultsQREE2 ($rows) {  	echo "<table cellpadding=7 bgcolor=$resultsColor>\n";  	foreach ($rows as $row) {		echo "\n\n\n<tr>\n<td valign=top>\n";		echoDocumentLink2($row[3],$row[6],$row[7]);		echo "<td><font color=blue>".$row[0]."</font><br>";		echoTwoSentences($row[3],$row[4],$row[5],$row[6],$row[7],false);  	}  	echo "</table>\n";}function orderRows ($rows){	// Input is an array of rows with the following fields:	// id, str, id1, str1, rel, id2, str2, file, sent1, and sent2. 	// Here, id and str are the id and str for the search term.  	// Create  a dictionary indexed on rel, values are dictionaries indexed	// on the string related to the search term (or pivot). The values in 	// the embedded dictionaries are rows consisting of relatedString, 	// rel, pivotString, file, sent1, sent2, id1, and id2.		$orderedRows = array();	foreach ($rows as $row)	{		$id1 = $row[2];		$id2 = $row[5];		$pivot = $row[0];		$pivotString = $row[1];		if ($pivot == $id1) {			$reltype = reverseReltype($row[4]);			$related = $id2;			$relatedString = $row[6]; }		if ($pivot == $id2) {			$reltype = $row[4];			$related = $id1;			$relatedString = $row[3]; }		if (! $relatedString) { continue; } // skip empty events and times		$adjustedRow = array($relatedString,$reltype,$pivotString,$row[7],$row[8],$row[9],$row[2],$row[5]);		if (! ( array_key_exists($reltype,$orderedRows) and				array_key_exists($relatedString,$orderedRows[$reltype]))) {			$orderedRows[$reltype][$relatedString] = array(); }		array_push($orderedRows[$reltype][$relatedString],$adjustedRow);	}	return $orderedRows;}function reverseReltype ($string){	if ($string == 'AFTER') { return 'BEFORE'; }	if ($string == 'IAFTER') { return 'IBEFORE'; }	if ($string == 'BEFORE') { return 'AFTER'; }	if ($string == 'IBEFORE') { return 'IAFTER'; }	if ($string == 'IDENTITY') { return 'IDENTITY'; }	if ($string == 'SIMULTANEOUS') { return 'SIMULTANEOUS'; }	if ($string == 'DURING') { return 'DURING'; }	if ($string == 'INCLUDES') { return 'IS_INCLUDED'; }	if ($string == 'IS_INCLUDED') { return 'INCLUDES'; }	if ($string == 'BEGINS') { return 'BEGUN_BY'; }	if ($string == 'ENDS') { return 'ENDED_BY'; }	if ($string == 'BEGUN_BY') { return 'BEGINS'; }	if ($string == 'ENDED_BY') { return 'ENDS'; }	return $string . "-R";}function printRows ($rows){	// debugging utility, just dumpt the table rows  	echo "<table cellpadding=5 border=1>\n";	foreach ($rows as $row) {		$rowstring = implode('<td>',$row);		echo "<tr>\n<td valign=top>\n";		echo $rowstring; }  	echo "</table>\n";}function printListOfMatches ($rows){		echo "<table cellpadding=7>\n";	foreach ($rows as $row) {		echo "<tr>\n<td valign=top>\n";		echoDocumentLink2($row[7],$row[2],$row[5]);		$reltype = $row[4];		$str1 = $row[3];		$str2 = $row[6];		echo "<td><font color=blue><strong>[$str1]</strong> &nbsp; ";		echo "$reltype &nbsp; <strong>[$str2]</font></strong><p>\n";		echoTwoSentences($row[7],$row[8],$row[9],$row[2],$row[5],false);	}	echo "</table>\n";}function printOrderedRows ($dict){	global $resultsColor, $barColor;	$focus = getFocus();	echo "\n<table bgcolor=$resultsColor cellpadding=5>\n";	echo "<tr><td>\n";	echo "<table cellpadding=5 border=0><tr><td>\n";	foreach (array_keys($dict) as $reltype) {		$subdict = $dict[$reltype];		echo "<table width=100% bgcolor=$barColor><tr><td>$reltype</table>\n";		foreach (array_keys($subdict) as $related) {			echo "\n<p><strong><a name='$reltype-$related'><font color=blue>$related $reltype $focus<br></font></a></strong></p>\n";			echo "<table cellpadding=5>";			foreach ($dict[$reltype][$related] as $row) {				echo "\n\n<tr>\n  <td valign=top>\n    ";				echoDocumentLink2($row[3],$row[6],$row[7]);				echo "\n  <td>";				echoTwoSentences($row[3],$row[4],$row[5],$row[6],$row[7],false);			}			echo "\n\n</table>\n";		}		echo "<p>\n";	}	echo "</table>\n";	echo "</table>\n";}function getFocus (){	global $e, $t;	if ($e) { return $e; }	return $t;}function ppEventsForReltype ($dict,$reltype,$printHeader){	if ($printHeader) {		global $submit;		if ($submit == 'qT-E') { $objectType = 'TIMES'; }		else { $objectType = 'EVENTS'; }		if ($reltype == 'INCLUDES') { $header = "INCLUDING " . $objectType; }		elseif ($reltype == 'IS_INCLUDED') { $header = "INCLUDED " . $objectType; }		else { $header = $reltype; }		echo "    <i>" . strtolower($header) . "</i><br>\n";	}	if (array_key_exists($reltype,$dict)) {		foreach (array_keys($dict[$reltype]) as $relatedevent) {			$size = count($dict[$reltype][$relatedevent]);			echo "    <a href='#$reltype-$relatedevent'>";			echo "$relatedevent</a> ($size)<br>\n";		}	}}if ($submit == 'qT-E' and $e){	$searched = 1;	$fields1 = "eid2,str2,tid1,str1,reltype,eid2,str2,tmlfile,sentid1,sentid2";	$fields2 = "eid1,str1,eid1,str1,reltype,tid2,str2,tmlfile,sentid1,sentid2";	$q1 = "SELECT $fields1 from $EXPANDED_TLINKS_TABLE WHERE str2='$e' AND eid1=''";	$q2 = "SELECT $fields2 from $EXPANDED_TLINKS_TABLE WHERE str1='$e' AND eid2=''";	$rows = queryDB($q1,$q2);}elseif ($submit == 'qE-T' and $t){	$searched = 1;	$fields1 = "tid2,str2,eid1,str1,reltype,tid2,str2,tmlfile,sentid1,sentid2";	$fields2 = "tid1,str1,tid1,str1,reltype,eid2,str2,tmlfile,sentid1,sentid2";	$q1 = "SELECT $fields1 from $EXPANDED_TLINKS_TABLE WHERE str2='$t' AND tid1=''";	$q2 = "SELECT $fields2 from $EXPANDED_TLINKS_TABLE WHERE str1='$t' AND tid2=''";	$rows = queryDB($q1,$q2);}elseif ($submit == 'qE-E' and $e){	$searched = 1;	$fields1 = "eid1,str1,eid1,str1,reltype,eid2,str2,tmlfile,sentid1,sentid2";	$fields2 = "eid2,str2,eid1,str1,reltype,eid2,str2,tmlfile,sentid1,sentid2";	$q1 = "SELECT $fields1 from $EXPANDED_TLINKS_TABLE WHERE str1='$e' AND tid1='' AND tid2=''";	$q2 = "SELECT $fields2 from $EXPANDED_TLINKS_TABLE WHERE str2='$e' AND tid1='' AND tid2=''";	$rows = queryDB($q1,$q2);}elseif ($submit == 'qR(E-E)'){	if ($e1 and $e2) {		$searched = 1;		$fields = "reltype,str1,str2,tmlfile,sentid1,sentid2,eid1,eid2";		$q1 = "SELECT $fields from $EXPANDED_TLINKS_TABLE WHERE str1='$e1' AND str2='$e2' AND tid1='' AND tid2=''";		$q2 = "SELECT $fields from $EXPANDED_TLINKS_TABLE WHERE str1='$e2' AND str2='$e1' AND tid1='' AND tid2=''";		$rows = queryDB($q1,$q2);	} elseif ($e1 or $e2) {		$warning = "WARNING: you must enter two events";	}}?><!doctype html public "-//W3C//DTD HTML 4.0 //EN"> <html><head><title>Query TimeBank (<?php echo $_SERVER['SERVER_NAME'] ?>)</title><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><link href="timebank.css" rel="stylesheet" type="text/css"><style type="text/css"><!--.button { 	background-color: #ccccff;	font-weight: bold; }--></style><script language="JavaScript" type="text/JavaScript"><!--function MM_goToURL() { //v3.0  var i, args=MM_goToURL.arguments; document.MM_returnValue = false;  for (i=0; i<(args.length-1); i+=2) eval(args[i]+".location='"+args[i+1]+"'");}function MM_jumpMenu(targ,selObj,restore){ //v3.0  eval(targ+".location='"+selObj.options[selObj.selectedIndex].value+"'");  if (restore) selObj.selectedIndex=0;}function openExamples(queryType) {	window.open("query-examples.php?queryType="+queryType,				"Query Examples",				"width=600,height=150,status=no,scrollbars=yes,resizable=yes"); }//--></script></head><body><?php readfile("topnav.php"); ?><p><table cellpadding=5 bgcolor=<?php echo $headerColor ?>><tr><td><font size=+3>Query TimeBank</font></table><p><table><tr><td valign=top> <!-- QUERY TYPE SELECTOR --><form name="form1" method="GET" action="">  <table cellpadding=5 bgcolor=<?php echo $headerColor ?>>    <tr>      <td>         <select name="queryType" id="queryType" onChange="MM_jumpMenu('parent',this,0)">                <option value="<?php echo $scriptname ?>?submit=qE-E"<?php setSelected($submit,'qE-E')?>>qE-E</option>        <option value="<?php echo $scriptname ?>?submit=qT-E"<?php setSelected($submit,'qT-E')?>>qT-E</option>        <option value="<?php echo $scriptname ?>?submit=qE-T"<?php setSelected($submit,'qE-T')?>>qE-T</option>        <option value="<?php echo $scriptname ?>?submit=qR(E-E)"<?php setSelected($submit,'qR(E-E)')?>>qR(E-E)</option>        </select>  </table></form><td valign=top>  <!-- qT-E QUERIES --><?php if ($submit == 'qT-E') { ?><form action="<?php echo $_SERVER['PHP_SELF'] ?>" method=GET> <table cellpadding=5 bgcolor=<?php echo $headerColor ?>>   <tr>	<td align=left>       Anchorings for Event       <input name="e" size=15 value=<?php echo $HTTP_GET_VARS['e'] ?>>    <td valign=top>       <input name="go" type=submit class=button value='Go'>      <input name="submit" type=hidden class=button value='qT-E'></table></form><!-- qE-E QUERIES -->      <?php } elseif ($submit == 'qE-E') { ?>      <form action="<?php echo $_SERVER['PHP_SELF'] ?>" method=GET>        <table cellpadding=5 bgcolor=<?php echo $headerColor ?>>          <tr>             <td> Orderings for Event&nbsp <input name="e" size=15 value=<?php echo $HTTP_GET_VARS['e'] ?>>             <td valign=top> 			  <input name="go" type=submit class=button value='Go'>               <input name="submit" type=hidden class=button value='qE-E'>         </table>      </form>      <!-- qE-T QUERIES -->      <?php } elseif ($submit == 'qE-T') { ?>      <form action="<?php echo $_SERVER['PHP_SELF'] ?>" method=GET>        <table cellpadding=5 bgcolor=<?php echo $headerColor ?>>          <tr>             <td> Orderings relative to Time&nbsp <input name="t" size=15 value=<?php echo $HTTP_GET_VARS['t'] ?>>             <td valign=top>			  <input name="go" type=submit class=button value='Go'>               <input name="submit" type=hidden class=button value='qE-T'>         </table>      </form>      <!-- qR(E-E) QUERIES -->      <?php } elseif ($submit == 'qR(E-E)') { ?>      <form action="<?php echo $_SERVER['PHP_SELF'] ?>" method=GET>        <table cellpadding=5 bgcolor=<?php echo $headerColor ?>>          <tr>             <td> Relations between events               <input name="e1" size=15 value=<?php echo $HTTP_GET_VARS['e1'] ?>>              and               <input name="e2" size=15 value=<?php echo $HTTP_GET_VARS['e2'] ?>>             <td valign=top>			  <input name="go" type=submit class=button value='Go'>               <input name="submit" type=hidden class=button value='qR(E-E)'>         </table>      </form>      <?php } ?>  </table>  <p>   <?php if ($warning) { ?><p><strong><font color=red><?php echo $warning ?></font></strong></p><?php } ?><?phpif ($searched) {	//$matchCount = count($rows);	//echo "<strong>$matchCount matches</strong><p>\n\n";	if ($submit == "qT-E" or $submit == "qE-T" or $submit == "qE-E") 	{ 		$dict = orderRows($rows);		$focus = getFocus(); ?><table bgcolor=<?php echo $resultsColor ?> cellpadding=5> <tr><td> <table cellpadding=0 border=0>	<tr>	<td width=100pt><td width=80pt><td width=20pt><td width=80pt>	<td width=20pt><td width=80pt><td width=20pt><td width=80pt><td width=100pt>	<tr>	<td colspan=2 valign=top rowspan=5 bgcolor=white>	<?php ppEventsForReltype ($dict,'BEFORE',true); ?>	<?php ppEventsForReltype ($dict,'IBEFORE',false); ?>	<td>	<td colspan=3 valign=top align=center bgcolor=<?php echo $barColor ?>>	  <strong><?php echo strtoupper($focus) ?></strong>	<td>	<td colspan=2 valign=top rowspan=5 bgcolor=white>	<?php ppEventsForReltype ($dict,'AFTER',true); ?>	<?php ppEventsForReltype ($dict,'IAFTER',false); ?>	<tr><td colspan=9 height=10>		<tr>	<td>	<td colspan=3 valign=top bgcolor=white>	<?php ppEventsForReltype ($dict,'IDENTITY',true); ?>	<td>	<tr><td colspan=5 height=10>	<tr>	<td colspan=1>	<td colspan=3 valign=top bgcolor=white>	<?php ppEventsForReltype ($dict,'SIMULTANEOUS',true); ?>	<?php ppEventsForReltype ($dict,'DURING',false); ?>	<td colspan=1>	<tr><td colspan=9 height=10>	<tr>	<td>	<td colspan=3 valign=top bgcolor=white>	<?php ppEventsForReltype ($dict,'INCLUDES',true); ?>	<td>	<td colspan=3 valign=top bgcolor=white>	<?php ppEventsForReltype ($dict,'IS_INCLUDED',true); ?>	<td>  </table></table><p><?php				printOrderedRows($dict);		//printListOfMatches($rows);	}	elseif ($submit == "qR(E-E)") { 		//$dict = orderRows($rows);		//printOrderedRows($dict);		echoResultsQREE2($rows); 	}}?></td></tr>  </table> </body></html>