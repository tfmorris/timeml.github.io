<?php# connection variablesrequire("connection.php");# timebank version and table names$TB_VERSION = 'TimeBank 1.2';$EVENTS_TABLE = 'tb_events';$INSTANCES_TABLE = 'tb_instances';$TIMEXES_TABLE = 'tb_timexes';$SIGNALS_TABLE = 'tb_signals';$ALINKS_TABLE = 'tb_alinks';$SLINKS_TABLE = 'tb_slinks';$TLINKS_TABLE = 'tb_tlinks';$EXPANDED_ALINKS_TABLE = 'tb_alinksExp';$EXPANDED_SLINKS_TABLE = 'tb_slinksExp';$EXPANDED_TLINKS_TABLE = 'tb_tlinksExp';$SENTENCES_TABLE = 'tb_sentences';// Connect to host and select database$db_conn = mysql_connect($hostname, $username, $password);if (mysql_errno()) {	echo "<hr><h2>$TB_VERSION Browser</h2>";	echo "<b><font color=#ff0000>There is a problem with the database connection, try again later.</font></b>";	echo "<p>Please send an email to marc@cs.brandeis.edu if the problem persists.<hr>";	exit;    echo mysql_errno() . ": " . mysql_error(). "\n<p><hr><p>\n\n";}mysql_select_db($db, $db_conn);if (mysql_errno()) {    echo mysql_errno() . ": " . mysql_error(). "\n<p><hr><p>\n\n";}function getDistinct($column,$table){	// Get all distinct values for column in table	global $db_conn;	$q = "SELECT distinct($column) FROM $table";	$result = mysql_query($q, $db_conn);  	if (mysql_errno()) { printMySqlErrors($q,$_SERVER['SCRIPT_NAME'] . ":" . __LINE__); }	$answer = Array();	while ($row = mysql_fetch_assoc($result)) { 		// skip empty values		if ($row[$column] != '') {			$answer[] = $row[$column]; }}	$nilOffset = array_search('**nil**',$answer);	if ($nilOffset !== false) {		array_splice($answer,$nilOffset,1); }	return $answer;}function allRowsForDocument($doc){	// return all rows from sentences for tmlfile $doc		global $db_conn, $SENTENCES_TABLE;	$query = "SELECT * FROM $SENTENCES_TABLE WHERE tmlfile = '$doc' order by sentid, offset";	$result = mysql_query($query, $db_conn);	if (mysql_errno()) {		printMySqlErrors($query,"displayArticle.php:10"); }	else {		while ($row = mysql_fetch_row($result)) {			#echo $row[1] . $row[2] .$row[3] . "<br>\n";			$rows[] = $row; }}	return $rows;}function allEventRowsForDocument($doc,$table){	// return all event/instance rows from $table for tmlfile $doc	global $db_conn;	$query = "SELECT * FROM $table WHERE tmlfile = '$doc'";	//if ($table == 'tb_events') {	//	$query = "SELECT * FROM $table WHERE tmlfile = '$doc' order by sentid"; }	// echo $query;	$result = mysql_query($query, $db_conn);	$rows = Array();	if (mysql_errno()) {		printMySqlErrors($query,"allLinkRowsForDocument($doc,$table)"); }	else {		while ($row = mysql_fetch_assoc($result)) {			$rows[] = $row; }}	return $rows; }function allLinkRowsForDocument($doc,$table){	// return all rows from linktable $table for tmlfile $doc	if ($table == "all") {		return allLinkRowsForDocumentAux($doc); }	global $db_conn;	$query = "SELECT * FROM $table WHERE tmlfile = '$doc'";	$result = mysql_query($query, $db_conn);	$rows = Array();	if (mysql_errno()) {		printMySqlErrors($query,"allLinkRowsForDocument($doc,$table)"); }	else {		while ($row = mysql_fetch_assoc($result)) {			$rows[] = $row; }}	return $rows; }function allLinkRowsForDocumentAux($doc){	// return all rows from all linktables for tmlfile $doc	global $db_conn, $ALINKS_TABLE, $SLINKS_TABLE, $TLINKS_TABLE;	$tables = Array($ALINKS_TABLE, $SLINKS_TABLE, $TLINKS_TABLE);	foreach ($tables as $table) {		$query = "SELECT * FROM $table WHERE tmlfile = '$doc'";		$result = mysql_query($query, $db_conn);		if (mysql_errno()) {			printMySqlErrors($query,"allLinkRowsForDocumentAux($doc)"); }		else {			while ($row = mysql_fetch_assoc($result)) {				$rows[] = $row; }}}	return $rows; }function echoDocument ($fileName,$highlightIDs,$sep){	// Echo a document, including its header timex		$rows = allRowsForDocument($fileName);	$headerTimex = headerTimex($fileName);	if ($headerTimex) {		if ($headerTimex[5] != 'NONE') { 			echo $headerTimex[5] . ': '; }		$highlight = $highlightIDs[$headerTimex[1]];		echo "<span id=$headerTimex[1]>";		if ($highlight) { 			echo '<span class=highlight>'; }		echo "<span class=timex>$headerTimex[9]</span>";		if ($highlight) { 			echo '</span>'; }		echo "<sup>$headerTimex[1]</sup></span><br><br>\n\n";	}	echoSentenceRows($rows,$highlightIDs,$sep,true); }function echoSentence ($file,$sentid,$ids,$markObjects) {	// Echo $sentence $sentid from tmlfile $file. Highlight the event,	// timex or signal identified by an id from the array $ids.		if ($sentid == 0) {		$head = headerTimex($file);		//$c = 0;		//foreach ($head as $el) {		//	$c++;		//	echo "$c=$el &nbsp; "; }		echo "0--&nbsp; " . $head[9]; 		return; }  	global $db_conn, $SENTENCES_TABLE;  	$query = "select * from $SENTENCES_TABLE where tmlfile='$file' and sentid='$sentid' order by sentid, offset";  	$result = mysql_query($query, $db_conn);  	if (mysql_errno()) {  		printMySqlErrors($query,"echoSentence($file,$sentid,$id,$markObjects)"); 	} else {  		$rows = Array();		while ($row = mysql_fetch_row($result)) {			//echo $row[1] .$row[2] .$row[3] . "<br>\n";			$rows[] = $row; 		}	}	$highlightIDs = Array(); 	foreach ($ids as $id) {	$highlightIDs[$id] = 1; }  	echoSentenceRows($rows,$highlightIDs,'',$markObjects);}function echoSentenceRows ($rows, $highlightIDs, $sep, $markObjects) {   // Echo rows from $SENTENCES_TABLE, insert breaks just before every   // first token of a sentence. The $printID variable is used to   // print sentence numbers. May need to add parameters to control   // whether and how numbers are printed.  	$printID = 1;	echo "<table cellpadding=5>\n";  	foreach ($rows as $row) {		if ($row[2] == 1) { 			#echo "\n$sep\n"; 			$printID = 1; }		// strip the | from the varchar field		$text = substr($row[3],0,-1);		$tag = $row[4];		$id = $row[5];		if ($printID) {			$sentid = $row[1];			#echo "$sentid--&nbsp;";		  	echo "<tr><td align=\"right\" valign=\"top\">$sentid<td valign=\"top\">";		  	$printID = 0; 		}		if ($tag) {			echoTag($id,$tag,$highlightIDs[$id],$text,$markObjects);			echo "\n";		} else {	  		echo $text; 			echo "\n";		}	}	echo "</table>\n";}function echoTag ($id,$tag,$highlight,$text,$markObjects){	// Echo a tag, printing highlights and markings if requested		echo "<span id=$id>";	if ($markObjects) {		if ($tag == 'EVENT') { echo "<span class=event>"; } 		elseif ($tag == 'TIMEX3') { echo "<span class=timex>"; } 		else  { echo " <span class=signal>"; }	}	if ($highlight) { echo '<strong>'; }	if ($id{0} == 'e') { $tagtype = 'event'; }	elseif ($id{0} == 't') { $tagtype = 'timex'; }	elseif ($id{0} == 's') { $tagtype = 'signal'; }	echo "<span style=\"cursor:crosshair\" onClick=\"MM_goToURL('parent','displayTag.php?tagtype=$tagtype&text=$text')\">";	echo $text;	echo "</span>";	if ($highlight) { echo '</strong>'; }	if ($markObjects) {		echo '</span><sub>'.$id.'</sub>';	}	echo "</span>";}function echoLinkSearch ($rows) {
	// Present search results for links. Print a table with two	// columns, the first one has an image that links to a file, the	// second has a sentence with events etc marked and some elements	// highlighted.	// NEED TO ADD EXTRA PARAMATERS THAT KEEP TRACK OF WHAT TIMEXES OR	// EVENTS TO HIGHLIGHT, DO THIS THE SAME WAY AS echoResultsXXX  	echo "<table cellpadding=7>\n";  	foreach ($rows as $row) {		echo "<tr><td valign=top>\n";		echoDocumentLink($row);		echo "<td>".$row['reltype'];		$descr1 = implode(' ',array($row['str1'],$row['class1'],$row['tense1'],$row['aspect1'],$row['type1'],$row['value1']));		$descr2 = implode(' ',array($row['str2'],$row['class2'],$row['tense2'],$row['aspect2'],$row['type2'],$row['value2']));		echo " { $descr1 } { $descr2 }<br>\n";		echoTwoSentences($row['tmlfile'],$row['sentid1'],$row['sentid2'],						 $row['eid1'],$row['eid2'],true);  	}  	echo "</table>\n";}function echoDocumentLink ($row){	// Create a link that will display an document, using the file	// name and the event ids that need to be highlighted.	$file = $row[3];	$id1 = $row[6];	$id2 = $row[7];	$file = $row['tmlfile'];	$id1 = $row['eid1'];	$id2 = $row['eid2'];	echo "<a href=displayArticle.php?file=$file&highlight=$id1,$id2 target=_NEW>";	echo "<img src=inline004.gif border=0></a>\n";}function echoDocumentLink2 ($file,$id1,$id2){	// Create a link that will display an document, using the file	// name and the event ids that need to be highlighted.	// *** Very similar to echoDocumentLink, need to merge them		echo "<a href=displayArticle.php?file=$file&highlight=$id1,$id2 target=_NEW>";	echo "<img src=inline004.gif border=0></a>\n";}function echoTwoSentences($file,$sentid1,$sentid2,$eid1,$eid2,$markObjects){	// Echo two sentences, sorted on sentence id. Echo only one	// sentence if the two ids are identical.	    if ($sentid1 == $sentid2) {		echoSentence($file,$sentid1,Array($eid1,$eid2),$markObjects);    } elseif ($sentid1 < $sentid2) {		echoSentence($file,$sentid1,Array($eid1,$eid2),$markObjects); 		echo "<br>";		echoSentence($file,$sentid2,Array($eid1,$eid2),$markObjects);     } else {		echoSentence($file,$sentid2,Array($eid1,$eid2),$markObjects); 		echo "<br>";		echoSentence($file,$sentid1,Array($eid1,$eid2),$markObjects);     }}  function headerTimex($doc){	// returns 0 or the headerTimex for tmlfile $doc	global $db_conn, $TIMEXES_TABLE;	$query = "SELECT * FROM $TIMEXES_TABLE WHERE tmlfile = '$doc' AND sentid = 0";	$result = mysql_query($query, $db_conn);	if (mysql_errno()) {		printMySqlErrors($query,"headerTimex($doc)"); }	else {		$numrows = mysql_num_rows($result);		if ($numrows > 0) {			$headerTimex = mysql_fetch_row($result); }		else {			$headerTimex = 0; }}	return $headerTimex; }// FOR THE QUERY TOOLfunction echoResultsQREE ($rows) {  	echo "<table cellpadding=7>\n";  	foreach ($rows as $row) {		echo "\n\n\n<tr>\n<td valign=top>\n";		echoDocumentLink($row);		echo "<td><font color=blue>".$row[0]."</font><br>";		echoTwoSentences($row[3],$row[4],$row[5],$row[6],$row[7],false);  	}  	echo "</table>\n";}function echoResultsQTE($rows) {  	echo "<table cellpadding=7>\n";  	foreach ($rows as $row) {		echo "<tr>\n<td valign=top>\n";		echoDocumentLink($row);		$reltype = $row[0];		$str1 = $row[1];		$str2 = $row[2];		echo "<td><font color=blue><strong>[$str1]</strong> &nbsp; ";		echo "$reltype &nbsp; <strong>[$str2]</font></strong><p>\n";		echoTwoSentences($row[3],$row[4],$row[5],$row[6],$row[7],false);  	}  	echo "</table>\n";}// Debug utilityfunction printMySqlErrors($query,$caller) {	if (mysql_errno()) {    	echo 'MySQL Error:' . mysql_errno() . ": " . mysql_error(). "\n";		echo "<p>Query: $query<p>Caller: $caller<p><hr><p>\n\n"; }}?>